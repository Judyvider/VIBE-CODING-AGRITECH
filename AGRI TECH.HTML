<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgriConnect: Agri-Tech for Farmers</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fbeb;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .mobile-container {
            width: 100%;
            max-width: 420px;
            min-height: 100vh;
            background-color: #ffffff;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border-radius: 2rem;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 8px solid #333;
        }

        .scroll-container {
            overflow-y: auto;
            flex-grow: 1;
        }

        .input-hidden {
            display: none;
        }

        .ussd-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            max-width: 300px;
            background: #fff;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            padding: 1.5rem;
            z-index: 50;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 40;
        }
    </style>
</head>

<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <!-- Mobile-like container -->
    <div class="mobile-container">
        <!-- Header -->
        <header class="bg-green-700 p-6 rounded-t-xl text-center shadow-lg sticky top-0 z-10">
            <h1 class="text-3xl font-bold text-white tracking-wide">AgriConnect</h1>
        </header>

        <!-- Main content scrollable area -->
        <div class="scroll-container p-6 space-y-8">

            <!-- AI-Powered Crop Advisor Section -->
            <section class="bg-green-50 p-6 rounded-3xl shadow-lg border border-green-200">
                <div class="flex items-center space-x-3 mb-4">
                    <span class="text-3xl">üå±</span>
                    <h2 class="text-xl font-bold text-green-800">Crop Advisor</h2>
                </div>
                <p class="text-gray-600 mb-4">Snap a photo of your plant to identify diseases and get instant solutions.</p>
                <input type="file" id="plant-image-input" class="input-hidden" accept="image/*" />
                <button id="upload-btn" class="w-full py-3 px-4 bg-green-500 hover:bg-green-600 text-white font-medium rounded-full shadow-md transition-transform transform hover:scale-105">
                    Upload Plant Photo
                </button>
                <div id="advisor-results" class="mt-4 hidden p-4 bg-white rounded-2xl shadow-inner border border-green-100">
                    <!-- Results will be displayed here -->
                </div>
            </section>

            <!-- Personalized Nutrition & Health Planner Section -->
            <section class="bg-yellow-50 p-6 rounded-3xl shadow-lg border border-yellow-200">
                <div class="flex items-center space-x-3 mb-4">
                    <span class="text-3xl">üçé</span>
                    <h2 class="text-xl font-bold text-yellow-800">Nutrition Planner</h2>
                </div>
                <p class="text-gray-600 mb-4">Create a balanced meal plan from your local crops.</p>
                <div class="space-y-3">
                    <label class="flex items-center text-gray-700">
                        <input type="checkbox" name="crop" value="maize" class="form-checkbox text-yellow-500 rounded-lg">
                        <span class="ml-2">Maize</span>
                    </label>
                    <label class="flex items-center text-gray-700">
                        <input type="checkbox" name="crop" value="beans" class="form-checkbox text-yellow-500 rounded-lg">
                        <span class="ml-2">Beans</span>
                    </label>
                    <label class="flex items-center text-gray-700">
                        <input type="checkbox" name="crop" value="sorghum" class="form-checkbox text-yellow-500 rounded-lg">
                        <span class="ml-2">Sorghum</span>
                    </label>
                    <label class="flex items-center text-gray-700">
                        <input type="checkbox" name="crop" value="spinach" class="form-checkbox text-yellow-500 rounded-lg">
                        <span class="ml-2">Spinach</span>
                    </label>
                    <label class="flex items-center text-gray-700">
                        <input type="checkbox" name="crop" value="sweet-potatoes" class="form-checkbox text-yellow-500 rounded-lg">
                        <span class="ml-2">Sweet Potatoes</span>
                    </label>
                </div>
                <button id="generate-plan-btn" class="w-full mt-5 py-3 px-4 bg-yellow-500 hover:bg-yellow-600 text-white font-medium rounded-full shadow-md transition-transform transform hover:scale-105">
                    Generate Meal Plan
                </button>
                <div id="nutrition-results" class="mt-4 hidden p-4 bg-white rounded-2xl shadow-inner border border-yellow-100">
                    <!-- Meal plan will be displayed here -->
                </div>
            </section>

            <!-- Interactive Learning Modules Section -->
            <section class="bg-blue-50 p-6 rounded-3xl shadow-lg border border-blue-200">
                <div class="flex items-center space-x-3 mb-4">
                    <span class="text-3xl">üìö</span>
                    <h2 class="text-xl font-bold text-blue-800">Learning Modules</h2>
                </div>
                <p class="text-gray-600 mb-4">Bite-sized lessons on sustainable farming practices.</p>

                <!-- Accordion/Module 1 -->
                <div class="learning-module mb-4 cursor-pointer">
                    <div class="flex justify-between items-center py-3 px-4 bg-blue-100 rounded-xl shadow-sm hover:bg-blue-200 transition-colors">
                        <h3 class="font-medium text-blue-800">Soil Management Basics</h3>
                        <span class="text-blue-600 toggle-icon">+</span>
                    </div>
                    <div class="module-content hidden mt-2 p-4 bg-white rounded-xl shadow-inner border border-blue-100">
                        <p class="text-gray-700">Healthy soil is the foundation of good farming. Learn how to maintain soil fertility through composting, crop rotation, and reducing tillage. This helps prevent erosion and keeps your plants strong.</p>
                    </div>
                </div>

                <!-- Accordion/Module 2 -->
                <div class="learning-module mb-4 cursor-pointer">
                    <div class="flex justify-between items-center py-3 px-4 bg-blue-100 rounded-xl shadow-sm hover:bg-blue-200 transition-colors">
                        <h3 class="font-medium text-blue-800">Water Conservation</h3>
                        <span class="text-blue-600 toggle-icon">+</span>
                    </div>
                    <div class="module-content hidden mt-2 p-4 bg-white rounded-xl shadow-inner border border-blue-100">
                        <p class="text-gray-700">Water is a precious resource. Discover simple techniques like drip irrigation and rainwater harvesting to ensure your crops get the water they need without wasting it. Small changes can make a big difference.</p>
                    </div>
                </div>

                <!-- Accordion/Module 3 -->
                <div class="learning-module mb-4 cursor-pointer">
                    <div class="flex justify-between items-center py-3 px-4 bg-blue-100 rounded-xl shadow-sm hover:bg-blue-200 transition-colors">
                        <h3 class="font-medium text-blue-800">Organic Pest Control</h3>
                        <span class="text-blue-600 toggle-icon">+</span>
                    </div>
                    <div class="module-content hidden mt-2 p-4 bg-white rounded-xl shadow-inner border border-blue-100">
                        <p class="text-gray-700">Protect your crops naturally. This module covers how to use beneficial insects, companion planting, and homemade sprays to keep pests away without harmful chemicals. It's a safer, healthier way to farm.</p>
                    </div>
                </div>

            </section>

            <!-- Local Market & E-commerce Section -->
            <section class="bg-purple-50 p-6 rounded-3xl shadow-lg border border-purple-200">
                <div class="flex items-center space-x-3 mb-4">
                    <span class="text-3xl">üõí</span>
                    <h2 class="text-xl font-bold text-purple-800">Local Market</h2>
                </div>
                <p class="text-gray-600 mb-4">List your surplus produce to sell to local communities and earn income.</p>
                <div class="space-y-4">
                    <div>
                        <label for="produce-name" class="block text-sm font-medium text-gray-700">Produce Name</label>
                        <input type="text" id="produce-name" placeholder="e.g., Fresh Tomatoes" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border-2">
                    </div>
                    <div>
                        <label for="produce-quantity" class="block text-sm font-medium text-gray-700">Quantity (kg)</label>
                        <input type="number" id="produce-quantity" placeholder="e.g., 50" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border-2">
                    </div>
                    <div>
                        <label for="produce-price" class="block text-sm font-medium text-gray-700">Price per kg (KES)</label>
                        <input type="number" id="produce-price" placeholder="e.g., 20" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border-2">
                    </div>
                </div>
                <button id="list-produce-btn" class="w-full mt-5 py-3 px-4 bg-purple-500 hover:bg-purple-600 text-white font-medium rounded-full shadow-md transition-transform transform hover:scale-105">
                    List Produce for Sale
                </button>
                <div id="market-results" class="mt-4 hidden p-4 bg-white rounded-2xl shadow-inner border border-purple-100">
                    <!-- Market results will be displayed here -->
                </div>

                <!-- Listed Produce Display Section -->
                <div class="mt-6">
                    <h3 class="text-lg font-bold text-purple-800 mb-2">Listed Produce by Farmers</h3>
                    <div id="listed-produce-container" class="space-y-2">
                        <!-- Listed produce items will be dynamically inserted here -->
                    </div>
                </div>
            </section>

            <!-- Payments Section -->
            <section class="bg-gray-50 p-6 rounded-3xl shadow-lg border border-gray-200">
                <div class="flex items-center space-x-3 mb-4">
                    <span class="text-3xl">üí∞</span>
                    <h2 class="text-xl font-bold text-gray-800">Accept & View Payments</h2>
                </div>
                <p class="text-gray-600 mb-4">View payments received from buyers and accept a simulated payment.</p>
                <div id="payment-options" class="flex flex-col space-y-4 hidden">
                    <button id="mpesa-pay-btn" class="w-full py-3 px-4 bg-green-600 hover:bg-green-700 text-white font-medium rounded-full shadow-md transition-transform transform hover:scale-105">
                        Accept M-Pesa Payment
                    </button>
                    <button id="card-pay-btn" class="w-full py-3 px-4 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-full shadow-md transition-transform transform hover:scale-105">
                        Accept Card Payment
                    </button>
                    <button id="qr-pay-btn" class="w-full py-3 px-4 bg-orange-600 hover:bg-orange-700 text-white font-medium rounded-full shadow-md transition-transform transform hover:scale-105">
                        Accept QR Code Payment
                    </button>
                </div>
                <div class="mt-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-2">Received Payments</h3>
                    <div id="payments-list" class="space-y-2">
                        <!-- Payment history will be dynamically inserted here -->
                    </div>
                </div>
            </section>

            <!-- USSD Access Section (Simulated) -->
            <section class="bg-indigo-50 p-6 rounded-3xl shadow-lg border border-indigo-200">
                <div class="flex items-center space-x-3 mb-4">
                    <span class="text-3xl">üìû</span>
                    <h2 class="text-xl font-bold text-indigo-800">USSD for All</h2>
                </div>
                <p class="text-gray-600 mb-4">No smartphone? No problem! Dial the USSD code below to access key features.</p>
                <div class="flex justify-center items-center p-4 bg-indigo-200 rounded-xl shadow-inner mb-4">
                    <span class="text-lg font-mono font-bold text-indigo-700">*483*57#</span>
                </div>
                <button id="ussd-btn" class="w-full py-3 px-4 bg-indigo-500 hover:bg-indigo-600 text-white font-medium rounded-full shadow-md transition-transform transform hover:scale-105">
                    Simulate USSD Menu
                </button>
            </section>
        </div>
    </div>

    <!-- USSD Simulation Popup -->
    <div id="ussd-overlay" class="overlay hidden"></div>
    <div id="ussd-popup" class="ussd-popup hidden">
        <h3 class="text-xl font-bold text-center mb-4">USSD Menu</h3>
        <p class="text-gray-700 text-center mb-2">Welcome to AgriConnect!</p>
        <div class="bg-gray-100 p-4 rounded-xl space-y-2">
            <p>1. Crop Advisor</p>
            <p>2. Nutrition Planner</p>
            <p>3. Local Market</p>
            <p>4. Exit</p>
        </div>
        <button id="close-ussd-popup" class="w-full mt-4 py-2 px-4 bg-red-500 text-white font-medium rounded-full">Close</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Log all Firestore actions to the console for debugging
        setLogLevel('debug');

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase services
        let app, db, auth;
        let userId = null;
        let isAuthReady = false;

        // Function to create a custom modal
        function showModal(message, type) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 flex items-center justify-center p-4 bg-black bg-opacity-50 z-50 transition-opacity duration-300 ease-in-out';
            modal.innerHTML = `
                <div class="bg-white p-6 rounded-2xl shadow-xl w-full max-w-sm transform transition-transform duration-300 ease-in-out scale-95 opacity-0">
                    <div class="text-center">
                        <div class="flex items-center justify-center mb-4">
                            ${type === 'success' ? '<svg class="w-12 h-12 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>' : ''}
                            ${type === 'error' ? '<svg class="w-12 h-12 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>' : ''}
                            ${type === 'info' ? '<svg class="w-12 h-12 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>' : ''}
                        </div>
                        <h3 class="text-xl font-bold text-gray-900 mb-2">${type.toUpperCase()}</h3>
                        <p class="text-gray-600 mb-6">${message}</p>
                        <button id="modal-close-btn" class="bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-full hover:bg-gray-300 transition-colors">Close</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // Animate in the modal
            setTimeout(() => {
                modal.querySelector('div').classList.remove('scale-95', 'opacity-0');
                modal.style.opacity = '1';
            }, 10);

            // Close modal functionality
            document.getElementById('modal-close-btn').addEventListener('click', () => {
                modal.querySelector('div').classList.add('scale-95', 'opacity-0');
                modal.style.opacity = '0';
                setTimeout(() => modal.remove(), 300);
            });
        }

        // Function to set up real-time Firestore listeners
        function setupFirestoreListeners() {
            // Real-time listener for produce listings
            const producePath = `artifacts/${appId}/public/data/produce-listings`;
            const produceRef = collection(db, producePath);
            onSnapshot(produceRef, (querySnapshot) => {
                const listings = [];
                querySnapshot.forEach((doc) => {
                    listings.push({ id: doc.id, ...doc.data() });
                });
                listings.sort((a, b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));
                renderProduceListings(listings);
            }, (error) => {
                console.error("Error fetching produce listings:", error);
            });

            // Real-time listener for payments
            const paymentsPath = `artifacts/${appId}/public/data/payments`;
            const paymentsRef = collection(db, paymentsPath);
            onSnapshot(paymentsRef, (querySnapshot) => {
                const payments = [];
                querySnapshot.forEach((doc) => {
                    payments.push({ id: doc.id, ...doc.data() });
                });
                payments.sort((a, b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));
                renderPayments(payments);
            }, (error) => {
                console.error("Error fetching payments:", error);
            });
        }

        // Function to render the produce listings in the UI
        function renderProduceListings(listings) {
            const container = document.getElementById('listed-produce-container');
            if (!container) return;
            container.innerHTML = '';
            if (listings.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 italic mt-4">No produce listed yet.</p>';
            } else {
                listings.forEach(item => {
                    const listingElement = document.createElement('div');
                    listingElement.className = 'bg-white p-4 rounded-xl shadow-sm border border-gray-200 mb-2';
                    listingElement.innerHTML = `
                        <h4 class="font-bold text-gray-800">${item.name}</h4>
                        <p class="text-sm text-gray-600">Quantity: ${item.quantity} kg</p>
                        <p class="text-sm text-gray-600">Price: KES ${item.price} / kg</p>
                        <p class="text-xs text-gray-400 mt-1">Listed by user: ${item.userId}</p>
                    `;
                    container.appendChild(listingElement);
                });
            }
        }

        // Function to render the payment list in the UI
        function renderPayments(payments) {
            const container = document.getElementById('payments-list');
            if (!container) return;
            container.innerHTML = '';
            if (payments.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 italic mt-4">No payments received yet.</p>';
            } else {
                payments.forEach(payment => {
                    const paymentElement = document.createElement('div');
                    paymentElement.className = 'bg-white p-4 rounded-xl shadow-sm border border-gray-200 mb-2';
                    paymentElement.innerHTML = `
                        <h4 class="font-bold text-gray-800">Payment of KES ${payment.amount}</h4>
                        <p class="text-sm text-gray-600">Method: ${payment.method}</p>
                        <p class="text-sm text-gray-600">For produce: ${payment.produceName}</p>
                        <p class="text-xs text-gray-400 mt-1">From user: ${payment.userId}</p>
                    `;
                    container.appendChild(paymentElement);
                });
            }
        }

        // Function to set up all event listeners once Firebase is ready
        function setupEventListeners() {
            const uploadBtn = document.getElementById('upload-btn');
            const plantImageInput = document.getElementById('plant-image-input');
            const advisorResults = document.getElementById('advisor-results');
            const generatePlanBtn = document.getElementById('generate-plan-btn');
            const nutritionResults = document.getElementById('nutrition-results');
            const learningModules = document.querySelectorAll('.learning-module');
            const listProduceBtn = document.getElementById('list-produce-btn');
            const produceNameInput = document.getElementById('produce-name');
            const produceQuantityInput = document.getElementById('produce-quantity');
            const producePriceInput = document.getElementById('produce-price');
            const marketResults = document.getElementById('market-results');
            const mpesaPayBtn = document.getElementById('mpesa-pay-btn');
            const cardPayBtn = document.getElementById('card-pay-btn');
            const qrPayBtn = document.getElementById('qr-pay-btn');
            const ussdBtn = document.getElementById('ussd-btn');
            const ussdPopup = document.getElementById('ussd-popup');
            const ussdOverlay = document.getElementById('ussd-overlay');
            const closeUssdPopup = document.getElementById('close-ussd-popup');
            const paymentOptions = document.getElementById('payment-options');

            // --- AI-Powered Crop Advisor Logic ---
            uploadBtn.addEventListener('click', () => {
                plantImageInput.click();
            });

            plantImageInput.addEventListener('change', (event) => {
                if (event.target.files.length > 0) {
                    const fileName = event.target.files[0].name;

                    const isCrop = Math.random() > 0.3;

                    advisorResults.classList.remove('hidden');
                    if (!isCrop) {
                        advisorResults.innerHTML = `
                            <div class="flex items-center justify-center space-x-2 text-red-600 font-bold mb-2">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.11 0 2.012-.89 2.012-1.999V5.01A2 2 0 0017.938 3H6.062a2 2 0 00-2 2v14.01c0 1.11.89 1.999 1.999 1.999zM21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                <span>Please upload a picture of a crop.</span>
                            </div>
                        `;
                        return;
                    }

                    advisorResults.innerHTML = `
                        <p class="text-center text-gray-500 animate-pulse">Analyzing image of "${fileName}"...</p>
                    `;

                    setTimeout(() => {
                        const randomResult = Math.random();
                        if (randomResult > 0.5) {
                            advisorResults.innerHTML = `
                                <div class="flex items-center justify-center space-x-2 text-green-600 font-bold mb-2">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                    <span>Identified: Tomato Late Blight</span>
                                </div>
                                <p class="text-sm text-gray-600 mb-2"><strong>Recommendation:</strong> Prune infected leaves and use a copper-based fungicide. Ensure good air circulation and avoid overhead watering.</p>
                            `;
                        } else {
                            advisorResults.innerHTML = `
                                <div class="flex items-center justify-center space-x-2 text-blue-600 font-bold mb-2">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                    <span>Identified: Nutrient Deficiency</span>
                                </div>
                                <p class="text-sm text-gray-600 mb-2"><strong>Recommendation:</strong> Add a balanced organic fertilizer rich in nitrogen and potassium to the soil. Water regularly to ensure proper nutrient absorption.</p>
                            `;
                        }
                    }, 2000);
                }
            });

            // --- Personalized Nutrition & Health Planner Logic ---
            const mealPlans = {
                'maize': 'Grilled Corn on the Cob with a sprinkle of salt and chili powder.',
                'beans': 'Hearty Bean and Sorghum stew, seasoned with local herbs.',
                'sorghum': 'Nutrient-rich Sorghum Porridge with mashed sweet potato.',
                'spinach': 'Fresh Spinach and Tomato Salad with a squeeze of lime.',
                'sweet-potatoes': 'Baked Sweet Potato with a side of steamed spinach.',
                'maize-beans': 'Succotash: A tasty mix of maize and beans.',
                'maize-sorghum': 'Sorghum and Cornmeal Fufu served with a savory stew.',
                'beans-spinach': 'A warm dish of Beans and saut√©ed Spinach.',
                'maize-sweet-potatoes': 'Sweet Potato and Maize Hash.',
                'all': 'A balanced meal of Sweet Potato and Maize Hash with a side of steamed Spinach, and a hearty Bean and Sorghum stew.'
            };

            generatePlanBtn.addEventListener('click', () => {
                const selectedCrops = Array.from(document.querySelectorAll('input[name="crop"]:checked'))
                    .map(checkbox => checkbox.value).sort();

                nutritionResults.classList.remove('hidden');

                if (selectedCrops.length === 0) {
                    nutritionResults.innerHTML = `<p class="text-center text-red-600">Please select at least one crop.</p>`;
                    return;
                }

                const planKey = selectedCrops.length > 1 ? selectedCrops.join('-') : selectedCrops[0];
                const planText = mealPlans[planKey] || mealPlans['all'];

                nutritionResults.innerHTML = `
                    <div class="flex items-center justify-center space-x-2 text-yellow-600 font-bold mb-2">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2 2m0 0l2-2m-2 2v2m0 0a4 4 0 014 4v2a4 4 0 01-4 4H7a4 4 0 01-4-4v-2a4 4 0 014-4h2m6 0a4 4 0 014-4v2a4 4 0 01-4 4H7"></path></svg>
                        <span>Your Personalized Meal Plan</span>
                    </div>
                    <p class="text-sm text-gray-700">${planText}</p>
                `;
            });

            // --- Interactive Learning Modules Logic (Accordion) ---
            learningModules.forEach(module => {
                const header = module.querySelector('div:first-of-type');
                const content = module.querySelector('.module-content');
                const toggleIcon = module.querySelector('.toggle-icon');

                header.addEventListener('click', () => {
                    learningModules.forEach(otherModule => {
                        if (otherModule !== module) {
                            const otherContent = otherModule.querySelector('.module-content');
                            const otherToggleIcon = otherModule.querySelector('.toggle-icon');
                            if (!otherContent.classList.contains('hidden')) {
                                otherContent.classList.add('hidden');
                                otherToggleIcon.textContent = '+';
                            }
                        }
                    });

                    content.classList.toggle('hidden');
                    if (content.classList.contains('hidden')) {
                        toggleIcon.textContent = '+';
                    } else {
                        toggleIcon.textContent = '-';
                    }
                });
            });

            // --- Local Market & E-commerce Logic (with Firestore Backend) ---
            listProduceBtn.addEventListener('click', async () => {
                if (!isAuthReady) {
                    showModal("Please wait for the app to connect to the database.", 'info');
                    return;
                }
                const produceName = produceNameInput.value.trim();
                const produceQuantity = parseFloat(produceQuantityInput.value.trim());
                const producePrice = parseFloat(producePriceInput.value.trim());

                if (!produceName || isNaN(produceQuantity) || produceQuantity <= 0 || isNaN(producePrice) || producePrice <= 0) {
                    showModal("Please fill out all fields with valid numbers.", 'error');
                    return;
                }

                marketResults.classList.remove('hidden');
                marketResults.innerHTML = `<p class="text-center text-gray-500 animate-pulse">Listing your produce...</p>`;

                const produceRef = collection(db, `artifacts/${appId}/public/data/produce-listings`);
                try {
                    await addDoc(produceRef, {
                        name: produceName,
                        quantity: produceQuantity,
                        price: producePrice,
                        userId: auth.currentUser.uid,
                        createdAt: new Date()
                    });

                    marketResults.innerHTML = `
                        <div class="flex items-center justify-center space-x-2 text-purple-600 font-bold mb-2">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            <span>Produce Listed Successfully!</span>
                        </div>
                        <p class="text-sm text-gray-700 mb-2">Your produce is now listed on the market.</p>
                        <p class="text-sm text-gray-700">Total estimated value: KES ${(produceQuantity * producePrice).toFixed(2)}</p>
                    `;

                    paymentOptions.classList.remove('hidden');
                    produceNameInput.value = '';
                    produceQuantityInput.value = '';
                    producePriceInput.value = '';

                } catch (e) {
                    console.error("Error adding document: ", e);
                    showModal("Failed to list produce. Please try again.", 'error');
                    marketResults.classList.add('hidden');
                }
            });

            // --- Payment Logic (with Firestore Backend) ---
            const addPayment = async (method, produceName) => {
                if (!isAuthReady) {
                    showModal("Please wait for the app to connect to the database.", 'info');
                    return;
                }
                const paymentsRef = collection(db, `artifacts/${appId}/public/data/payments`);
                const amount = Math.floor(Math.random() * 500) + 50; // Simulate a random payment
                try {
                    await addDoc(paymentsRef, {
                        produceName: produceName,
                        amount: amount,
                        method: method,
                        userId: auth.currentUser.uid,
                        createdAt: new Date()
                    });
                    showModal(`Payment of KES ${amount} via ${method} was successful!`, 'success');
                } catch (e) {
                    console.error("Error adding payment: ", e);
                    showModal("Failed to process payment. Please try again.", 'error');
                }
            };

            mpesaPayBtn.addEventListener('click', () => addPayment('M-Pesa', produceNameInput.value || "Some produce"));
            cardPayBtn.addEventListener('click', () => addPayment('Card', produceNameInput.value || "Some produce"));
            qrPayBtn.addEventListener('click', () => {
                // Simulate a QR code payment that's also successful
                addPayment('QR Code', produceNameInput.value || "Some produce");
            });

            // --- USSD Simulation Logic ---
            ussdBtn.addEventListener('click', () => {
                ussdOverlay.classList.remove('hidden');
                ussdPopup.classList.remove('hidden');
            });

            closeUssdPopup.addEventListener('click', () => {
                ussdOverlay.classList.add('hidden');
                ussdPopup.classList.add('hidden');
            });

            ussdOverlay.addEventListener('click', () => {
                ussdOverlay.classList.add('hidden');
                ussdPopup.classList.add('hidden');
            });
        }


        // Handle user authentication state
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                isAuthReady = true;
                console.log("User authenticated:", userId);
                setupFirestoreListeners();
                setupEventListeners();
            } else {
                console.log("User not authenticated. Signing in anonymously...");
                // Sign in with the provided custom token or anonymously
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                    userId = auth.currentUser.uid;
                    isAuthReady = true;
                    console.log("Signed in anonymously. User ID:", userId);
                    setupFirestoreListeners();
                    setupEventListeners();
                } catch (error) {
                    console.error("Firebase Auth Error:", error);
                    showModal("Failed to authenticate. Please try reloading the page.", 'error');
                }
            }
        });

        // Initialize Firebase on DOM content loaded
        document.addEventListener('DOMContentLoaded', () => {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        });
    </script>
</body>

</html>
